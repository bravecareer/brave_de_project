unit_tests:
  - name: test_urgent_stock_requirements_incremental
    description: "Test incremental logic for fact_urgent_stock_requirements_gs."
    model: fact_urgent_stock_requirements_gs
    overrides:
      macros:
        is_incremental: True
    given:
      - input: ref('view_inventory_data_transformed_gs')
        rows:
          - {INVENTORY_ID: 1, PRODUCT_ID: 'P001', QUANTITY_IN_STOCK: 2, Inventory_status: 'Backordered', NEXT_RESTOCK_DATE: '2024-03-05', UPDATED_AT: '2024-02-28 02:00:00', REORDER_LEVEL: 5}
          - {INVENTORY_ID: 3, PRODUCT_ID: 'P003', QUANTITY_IN_STOCK: 1, Inventory_status: 'Backordered', NEXT_RESTOCK_DATE: '2024-03-06', UPDATED_AT: '2024-02-28 04:00:00', REORDER_LEVEL: 3}
          - {INVENTORY_ID: 5, PRODUCT_ID: 'P005', QUANTITY_IN_STOCK: 10, Inventory_status: 'In Stock', NEXT_RESTOCK_DATE: '2024-03-10', UPDATED_AT: '2024-02-28 15:00:00', REORDER_LEVEL: 15}

      - input: ref('dim_product_data_gs')
        rows:
          - {PRODUCT_ID: 'P001', PRODUCT_NAME: 'Laptop Pro'}
          - {PRODUCT_ID: 'P003', PRODUCT_NAME: 'Wireless Keyboard'}
          - {PRODUCT_ID: 'P005', PRODUCT_NAME: 'Gaming Mouse'}

      - input: this
        rows:
          - {INVENTORY_ID: 1, PRODUCT_ID: 'P001', QUANTITY_IN_STOCK: 3, PRODUCT_NAME: 'Laptop Pro', NEXT_RESTOCK_DATE: '2024-03-05', UPDATED_AT: '2024-02-25 09:00:00'}

    expect:
      # Only expecting records that are:
      # 1. Backordered
      # 2. Below reorder level
      # 3. Updated after the last record in 'this'
      rows:
        - {INVENTORY_ID: 1, PRODUCT_ID: 'P001', QUANTITY_IN_STOCK: 2, PRODUCT_NAME: 'Laptop Pro', NEXT_RESTOCK_DATE: '2024-03-05', UPDATED_AT: '2024-02-28 02:00:00'}
        - {INVENTORY_ID: 3, PRODUCT_ID: 'P003', QUANTITY_IN_STOCK: 1, PRODUCT_NAME: 'Wireless Keyboard', NEXT_RESTOCK_DATE: '2024-03-06', UPDATED_AT: '2024-02-28 04:00:00'}