unit_tests:
  - name: test_incremental_updated_at_and_email_validation
    description: "Test incremental logic for updated_at, validate email addresses, and ensure updated records are handled correctly in dim_user_data_gs."
    model: dim_user_data_gs
    overrides:
      macros:
        # Force unit test to run in "full refresh" mode
        is_incremental: false  
    given:
      # New incoming data from the transformed table
      - input: ref('view_user_data_transformed_gs') 
        rows:
          - {user_id: 1, first_name: 'John', last_name: 'Doe', email: 'john.doe@example.com', signup_date: '2024-01-01', preferred_language: 'en', date_of_birth: '1990-01-01', marketing_opt_in: true, account_status: 'active', loyalty_points_balance: 100, updated_at: '2024-02-20 12:00:00'}
          - {user_id: 2, first_name: 'Jane', last_name: 'Smith', email: 'jane.smith@unknown', signup_date: '2024-01-10', preferred_language: 'en', date_of_birth: '1988-05-10', marketing_opt_in: false, account_status: 'inactive', loyalty_points_balance: 50, updated_at: '2024-02-21 13:15:30'}
          - {user_id: 3, first_name: 'Alice', last_name: 'Johnson', email: 'alice.johnson@example.com', signup_date: '2024-01-20', preferred_language: 'fr', date_of_birth: '1992-03-25', marketing_opt_in: true, account_status: 'active', loyalty_points_balance: 200, updated_at: '2024-02-22 09:45:10'}
          - {user_id: 4, first_name: 'Bob', last_name: 'Williams', email: 'invalid_email@email.com', signup_date: '2024-02-01', preferred_language: 'es', date_of_birth: '1985-08-15', marketing_opt_in: true, account_status: 'inactive', loyalty_points_balance: 0, updated_at: '2024-02-23 17:30:00'}
      
      # Current state of the `dim_user_data_gs` table before the incremental run
      - input: this  
        rows:
          - {user_id: 1, first_name: 'John', last_name: 'Doe', email: 'john.doe@example.com', signup_date: '2024-01-01', preferred_language: 'en', date_of_birth: '1990-01-01', marketing_opt_in: true, account_status: 'active', loyalty_points_balance: 100, updated_at: '2024-02-18 10:00:00'}
          - {user_id: 2, first_name: 'Jane', last_name: 'Smith', email: 'jane.smith@unknown.com', signup_date: '2024-01-10', preferred_language: 'en', date_of_birth: '1988-05-10', marketing_opt_in: false, account_status: 'inactive', loyalty_points_balance: 50, updated_at: '2024-02-19 15:45:00'}
          - {user_id: 3, first_name: 'Alice', last_name: 'Johnson', email: 'alice.johnson@example.com', signup_date: '2024-01-20', preferred_language: 'fr', date_of_birth: '1992-03-25', marketing_opt_in: true, account_status: 'active', loyalty_points_balance: 200, updated_at: '2024-02-20 08:30:00'}
    
    expect:
      rows:
        # User 1: Updated record (new `updated_at` timestamp)
        - {user_id: 1, first_name: 'John', last_name: 'Doe', email: 'john.doe@example.com', signup_date: '2024-01-01', preferred_language: 'en', date_of_birth: '1990-01-01', marketing_opt_in: true, account_status: 'active', loyalty_points_balance: 100, updated_at: '2024-02-20 12:00:00'}
        
        # User 2: Email changed in new data + updated_at updated
        - {user_id: 2, first_name: 'Jane', last_name: 'Smith', email: 'jane.smith@unknown', signup_date: '2024-01-10', preferred_language: 'en', date_of_birth: '1988-05-10', marketing_opt_in: false, account_status: 'inactive', loyalty_points_balance: 50, updated_at: '2024-02-21 13:15:30'}
        
        # User 3: More recent `updated_at`, so should be updated
        - {user_id: 3, first_name: 'Alice', last_name: 'Johnson', email: 'alice.johnson@example.com', signup_date: '2024-01-20', preferred_language: 'fr', date_of_birth: '1992-03-25', marketing_opt_in: true, account_status: 'active', loyalty_points_balance: 200, updated_at: '2024-02-22 09:45:10'}
        
        # User 4: New record, invalid email set to null
        - {user_id: 4, first_name: 'Bob', last_name: 'Williams', email: 'invalid_email@email.com', signup_date: '2024-02-01', preferred_language: 'es', date_of_birth: '1985-08-15', marketing_opt_in: true, account_status: 'inactive', loyalty_points_balance: 0, updated_at: '2024-02-23 17:30:00'}
